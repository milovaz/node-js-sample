pipeline {
    agent any
    tools {nodejs "node"}
    stages {
            
        stage('Git') {
          steps {
              script {
                checkoutRepository()
              }
          }
        }
        
        stage('Update artifacts') {
          steps { 
            azureServiceFabricUpdateArtifacts applicationManifestPath: 'infra/nodeSample/ApplicationManifest.xml', serviceManifestPath: 'infra/nodeSample/nodeSampleServicePkg/ServiceManifest.xml', serviceTargetVersion: "$BUILD_NUMBER", applicationTargetVersion: "$BUILD_NUMBER", credentials: 'acr-credentials', repositoryName: 'node-js-sample', environmentType: 'prod', passwordEncrypted: 'false' 
          }  
        }
        
        stage('Build') {
          steps{
            script {
                registry = sh (returnStdout: true, script: '''#!/bin/bash
                image_name=$(grep -oP \'<ImageName>\\K[^<]*\' infra/nodeSample/nodeSampleServicePkg/ServiceManifest.xml)
                echo $image_name''').trim()
            }
            script {
                dockerImage = docker.build registry
            }
          }
        }
        
        stage('Deploy Image') {
          steps{
             script {
                docker.withRegistry('https://moeda3.azurecr.io', 'acr-credentials') {
                dockerImage.push()
              }
            }
          }
        }
        
        stage('Deploy to service fabric') {
           steps {
                azureServiceFabricPublish applicationName: 'fabric:/nodeSample', applicationType: "nodeSampleType", azureCredentialsId: '', clientCert: "$JENKINS_HOME/cert.pem", clientKey: "$JENKINS_HOME/key_unencrypted.pem", configureType: 'fill', managementHost: 'moeda-cluster.brazilsouth.cloudapp.azure.com', manifestPath: 'infra/nodeSample/ApplicationManifest.xml', resourceGroup: '', serviceFabric: '', repositoryName: 'node-js-sample', environmentType: 'prod'
           }
        }
        
        stage('Inform Deploy') {
          steps {
            informGitDeployment(env.REPO_OWNER, env.REPO_NAME, env.DEPLOYMENT_ID)
          }  
        }
    }
    post {
        always {
            sendFeedbackToSlack '@thiagomilo'      
        }
    }
}
